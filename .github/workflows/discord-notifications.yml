name: PR Notifications

on:
  pull_request:
    types: [opened, review_requested, ready_for_review, closed]
  pull_request_review:
    types: [submitted]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    if: github.repository == 'Tugduoff/TalkUp.AI'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify PR opened
        # Only notify for opened PRs that are not drafts
        if: github.event.action == 'opened' && github.event.pull_request.draft == false
        uses: ./.github/actions/notify-discord
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "ðŸ“¥ Pull Request Opened"
          color: 65535
          description: |
            **Author:** `${{ github.actor }}`\n
            **Title:** `${{ github.event.pull_request.title }}`\n
            **Link:** [PR #${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }})
          usernames: ${{ github.actor }}

      - name: Notify reviewer requested
        if: github.event.action == 'review_requested' && github.event.pull_request.draft == false
        uses: ./.github/actions/notify-discord
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "ðŸ‘€ Reviewer Requested"
          color: 16776960
          description: |
            **PR:** [#${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }})\n
            **Requested Reviewer:** `${{ github.event.requested_reviewer.login }}`\n
            **By:** `${{ github.actor }}`
          usernames: ${{ github.event.requested_reviewer.login }}

      - name: Notify PR reviewed
        if: github.event.action == 'submitted'
        uses: ./.github/actions/notify-discord
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "ðŸ’¬ Pull Request Reviewed"
          color: ${{ github.event.review.state == 'approved' && 3066993 || github.event.review.state == 'changes_requested' && 16711680 || 5393746 }}
          description: |
            **Reviewer:** `${{ github.actor }}`\n
            **PR:** [#${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }})\n
            **Status:** `${{ github.event.review.state }}`\n
            **Title:** `${{ github.event.pull_request.title }}`
          usernames: ${{ github.event.pull_request.user.login }}

      - name: Notify PR merged
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        uses: ./.github/actions/notify-discord
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "âœ… Pull Request Merged"
          color: 2490126
          description: |
            **Author:** `${{ github.actor }}`\n
            **PR:** [#${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }})\n
            **Title:** `${{ github.event.pull_request.title }}`\n
            **Merged By:** `${{ github.event.pull_request.merged_by.login }}`
          usernames: "${{ github.actor }}"

      - name: Notify reviewers when a draft PR is marked ready
        # If the PR was originally a draft and is now marked as ready, notify any reviewers that were already set before ready
        if: github.event.action == 'ready_for_review' && toJson(github.event.pull_request.requested_reviewers) != '[]'
        uses: ./.github/actions/notify-discord
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "ðŸ‘€ Reviewer(s) on PR now ready"
          color: 16776960
          description: |
            **PR:** [#${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }})
            **Requested Reviewers:** ${{ join(github.event.pull_request.requested_reviewers.*.login, ', ') }}
            **By:** `${{ github.actor }}`
          usernames: ${{ join(github.event.pull_request.requested_reviewers.*.login, ',') }}
