name: Full CI Workflow

on:
  push:
    branches:
      - main
  pull_request:

env:
  MIRROR_REPO_URL: "git@github.com:EpitechPromo2027/G-EIP-600-NAN-6-1-eip-tugdual.de-reviers.git"

jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '23.x'

      - name: Setup and cache web dependencies
        uses: ./.github/actions/setup-node-with-cache
        with:
          working-directory: ./web

      - name: Setup and cache server Dependencies
        uses: ./.github/actions/setup-node-with-cache
        with:
          working-directory: ./server

      - name: Run Code Quality Check
        uses: ./.github/actions/run-quality-check

  tests_run:
    needs: code-quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '23.x'

      - name: Setup and cache web dependencies
        uses: ./.github/actions/setup-node-with-cache
        with:
          working-directory: ./web

      - name: Setup and cache server Dependencies
        uses: ./.github/actions/setup-node-with-cache
        with:
          working-directory: ./server

      - name: Run units tests command
        uses: ./.github/actions/run-units-tests

  push_mirror:
    needs: tests_run
    runs-on: ubuntu-latest

    # Only push to mirror if this is a merge of a pull request
    # if: github.event.action == 'closed' && github.event.pull_request.merged == true
    steps:
      - name: Push to mirror repo action
        uses: ./.github/actions/push-mirror
        with:
          target_repo_url: ${{ env.MIRROR_REPO_URL }}
          ssh_private_key: ${{ secrets.GIT_SSH_PRIVATE_KEY }}
