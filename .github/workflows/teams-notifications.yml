name: PR Teams Notifications

on:
  pull_request:
    types: [opened, review_requested, ready_for_review, closed]
  pull_request_review:
    types: [submitted]

jobs:
  notify-teams:
    runs-on: ubuntu-latest
    if: github.repository == 'Tugduoff/TalkUp.AI'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify PR opened
        # Only notify for opened PR that are not draft
        if: github.event.action == 'opened' && github.event.pull_request.draft == false
        uses: ./.github/actions/notify-teams
        with:
          webhook: ${{ secrets.TEAMS_WEBHOOK_URL }}
          title: "ðŸ“¥ New Pull Request Opened : ${{ github.event.pull_request.title }}"
          type: "opened"
          author: ${{ github.event.pull_request.user.login }}
          avatar_url: ${{ github.event.pull_request.user.avatar_url }}
          pr_url: ${{ github.event.pull_request.html_url }}

      - name: Notify reviewer requested
        # Only notify reviewer requests when the PR is not a draft.
        if: github.event.action == 'review_requested' && github.event.pull_request.draft == false
        uses: ./.github/actions/notify-teams
        with:
          webhook: ${{ secrets.TEAMS_WEBHOOK_URL }}
          title: "ðŸ‘€ Review Requested"
          avatar_url: ${{ github.event.pull_request.user.avatar_url }}
          type: "review_requested"
          author: ${{ github.event.pull_request.user.login }}
          reviewer: ${{ github.event.requested_reviewer.login }}
          pr_url: ${{ github.event.pull_request.html_url }}

      - name: Notify PR reviewed
        if: github.event.action == 'submitted'
        uses: ./.github/actions/notify-teams
        with:
          webhook: ${{ secrets.TEAMS_WEBHOOK_URL }}
          title: "ðŸ’¬ Pull Request Reviewed"
          avatar_url: ${{ github.event.review.user.avatar_url }}
          type: "reviewed"
          author: ${{ github.event.pull_request.user.login }}
          reviewer: ${{ github.event.review.user.login }}
          review_state: ${{ github.event.review.state }}
          pr_url: ${{ github.event.pull_request.html_url }}

      - name: Notify PR Merged
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        uses: ./.github/actions/notify-teams
        with:
          webhook: ${{ secrets.TEAMS_WEBHOOK_URL }}
          title: "âœ… PR Merged : ${{ github.event.pull_request.title }}"
          type: "closed"
          author: ${{ github.event.pull_request.user.login }}
          merger: ${{ github.event.pull_request.merged_by.login }}
          avatar_url: ${{ github.event.pull_request.merged_by.avatar_url }}
          pr_url: ${{ github.event.pull_request.html_url }}

      - name: Notify reviewers when a draft PR is marked ready
        # If the PR was originally a draft and is now marked as ready, notify any reviewers that were already set before ready
        if: github.event.action == 'ready_for_review' && toJson(github.event.pull_request.requested_reviewers) != '[]'
        uses: ./.github/actions/notify-teams
        with:
          webhook: ${{ secrets.TEAMS_WEBHOOK_URL }}
          title: "ðŸ‘€ Reviewers: PR now ready"
          type: "reviewer_ready"
          author: ${{ github.event.pull_request.user.login }}
          reviewer: ${{ join(github.event.pull_request.requested_reviewers.*.login, ',') }}
          pr_url: ${{ github.event.pull_request.html_url }}
